name: F1 2026 Auto-Retrain

on:
  # Run every Monday at 2 AM UTC (after race weekends)
  schedule:
    - cron: '0 2 * * 1'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  retrain:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run auto-retrain
        run: |
          python auto_retrain.py
        continue-on-error: true
      
      - name: Check for model updates
        id: check_updates
        run: |
          if git diff --quiet model/saved_models/; then
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            echo "updated=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push if updated
        if: steps.check_updates.outputs.updated == 'true'
        run: |
          git config --global user.name 'F1 Auto-Retrain Bot'
          git config --global user.email 'bot@f1predictor.com'
          git add .
          git commit -m "Auto-retrain: Updated model after race data collection"
          git push
      
      - name: Summary
        run: |
          if [ "${{ steps.check_updates.outputs.updated }}" == "true" ]; then
            echo "✅ Model updated and pushed to repository"
            echo "Render will auto-deploy the updated model"
          else
            echo "ℹ️ No new race data found - model unchanged"
          fi
